name: Deploy Website to VPS

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # BÆ°á»›c 1: Láº¥y mÃ£ nguá»“n vÃ o runner (khÃ´ng thay Ä‘á»•i)
      - name: Checkout code
        uses: actions/checkout@v3

      # BÆ°á»›c 2: Chuáº©n bá»‹ key Ä‘á»ƒ Káº¾T Ná»I VÃ€O VPS (khÃ´ng thay Ä‘á»•i)
      # Key nÃ y dÃ¹ng cho cháº·ng Runner -> VPS
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # BÆ°á»›c 3: Thá»±c thi lá»‡nh trÃªn VPS
      # VPS sáº½ tá»± dÃ¹ng Deploy Key cá»§a nÃ³ Ä‘á»ƒ káº¿t ná»‘i vá»›i GitHub
      - name: Deploy to VPS
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "
          # XÃ³a thÆ° má»¥c cÅ©
          echo 'ðŸ§¹ Cleaning up old directory...'
          rm -rf /var/www/psv
          
          # Clone repository
          echo 'ðŸšš Cloning repository...'
          git clone git@github.com:${{ github.repository }}.git /var/www/psv
          
          # Di chuyá»ƒn vÃ o thÆ° má»¥c vÃ  thá»±c hiá»‡n cÃ¡c bÆ°á»›c tiáº¿p theo
          cd /var/www/psv && \
          
          # CÃ i Ä‘áº·t dependencies (váº«n cáº§n thiáº¿t cho webhook.js)
          echo 'ðŸ“¦ Installing dependencies...' && \
          npm install && \
          
          # Cháº¡y script thÃ´ng bÃ¡o má»™t láº§n
          echo 'ðŸ”” Sending deployment notification...' && \
          node webhook.js && \
          
          echo 'âœ… Deployment script finished!'
          "