name: Deploy Website to VPS

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # B∆∞·ªõc 1: L·∫•y m√£ ngu·ªìn v√†o runner (kh√¥ng thay ƒë·ªïi)
      - name: Checkout code
        uses: actions/checkout@v3

      # B∆∞·ªõc 2: Chu·∫©n b·ªã key ƒë·ªÉ K·∫æT N·ªêI V√ÄO VPS (kh√¥ng thay ƒë·ªïi)
      # Key n√†y d√πng cho ch·∫∑ng Runner -> VPS
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # B∆∞·ªõc 3: Th·ª±c thi l·ªánh tr√™n VPS
      # VPS s·∫Ω t·ª± d√πng Deploy Key c·ªßa n√≥ ƒë·ªÉ k·∫øt n·ªëi v·ªõi GitHub
      - name: Deploy to VPS
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "
            # X√≥a th∆∞ m·ª•c c≈© ƒë·ªÉ ƒë·∫£m b·∫£o tr·∫°ng th√°i s·∫°ch s·∫Ω
            echo 'üßπ Cleaning up old directory...'
            rm -rf /var/www/psv
            
            # Clone l·∫°i to√†n b·ªô repository
            echo 'üöö Cloning repository...'
            git clone git@github.com:${{ github.repository }}.git /var/www/psv
            
            # Di chuy·ªÉn v√†o th∆∞ m·ª•c d·ª± √°n
            cd /var/www/psv
            
            # B∆Ø·ªöC QUAN TR·ªåNG B·ªä THI·∫æU
            echo 'üì¶ Installing dependencies...'
            npm install
            
            # Ch·∫°y ·ª©ng d·ª•ng b·∫±ng PM2 ƒë·ªÉ n√≥ t·ªìn t·∫°i trong n·ªÅn
            echo 'üöÄ Starting webhook with PM2...'
            pm2 start webhook.js --name psv-webhook
            
            echo '‚úÖ Deployment successful!'
          "